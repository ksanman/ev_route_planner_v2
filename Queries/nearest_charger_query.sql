WITH line AS ( SELECT ST_GeomFromText('LINESTRING(-111.8338 41.73711,
	-111.83484 41.73713,
	-111.83489 41.7352,
	-111.83495 41.73415,
	-111.83497 41.73341,
	-111.83497 41.73328,
	-111.83497 41.73317,
	-111.83498 41.73273,
	-111.83498 41.73233,
	-111.83499 41.73193,
	-111.835 41.73149,
	-111.83501 41.73138,
	-111.83501 41.73125,
	-111.83502 41.73114,
	-111.83504 41.73047,
	-111.83504 41.73018,
	-111.83505 41.73009,
	-111.83505 41.72996,
	-111.83505 41.72993,
	-111.83506 41.72956,
	-111.83507 41.7293,
	-111.83507 41.72902,
	-111.83508 41.72869,
	-111.8351 41.72775,
	-111.83513 41.72659,
	-111.83514 41.72602,
	-111.83514 41.72593,
	-111.8352 41.72402,
	-111.83526 41.72215,
	-111.83528 41.72116,
	-111.8353 41.72024,
	-111.83534 41.71927,
	-111.83539 41.71808,
	-111.83554 41.71762,
	-111.8356 41.71733,
	-111.83564 41.71706,
	-111.83575 41.71671,
	-111.83588 41.71637,
	-111.83606 41.71604,
	-111.83618 41.71584,
	-111.83648 41.71536,
	-111.83678 41.71487,
	-111.83681 41.71471,
	-111.83712 41.71433,
	-111.83734 41.71409,
	-111.83769 41.71375,
	-111.83815 41.71334,
	-111.83859 41.71301,
	-111.83944 41.71237,
	-111.83965 41.71221,
	-111.84064 41.71145,
	-111.84221 41.71027,
	-111.84272 41.70989,
	-111.84294 41.70973,
	-111.84442 41.70865,
	-111.84605 41.70742,
	-111.84822 41.70588,
	-111.84894 41.70537,
	-111.84913 41.70524,
	-111.84951 41.70494,
	-111.85063 41.70413,
	-111.85159 41.70342,
	-111.8528 41.70255,
	-111.85492 41.70101,
	-111.8561 41.70012,
	-111.85692 41.69952,
	-111.85748 41.69911,
	-111.85811 41.69865,
	-111.85873 41.69823,
	-111.85899 41.69804,
	-111.85974 41.69753,
	-111.86059 41.69692,
	-111.86115 41.69646,
	-111.86205 41.6958,
	-111.86222 41.69568,
	-111.86303 41.69504,
	-111.86349 41.69473,
	-111.8645 41.69389,
	-111.86543 41.69309,
	-111.8657 41.69283,
	-111.86732 41.69117,
	-111.87181 41.68669,
	-111.87301 41.6855,
	-111.87422 41.6843,
	-111.87587 41.6826,
	-111.87746 41.68103,
	-111.87878 41.6797,
	-111.87916 41.67933,
	-111.87959 41.6789,
	-111.88029 41.67821,
	-111.88133 41.67715,
	-111.88306 41.67539,
	-111.88766 41.6708,
	-111.89104 41.66737,
	-111.89449 41.66399,
	-111.89695 41.66165,
	-111.90005 41.65875,
	-111.90423 41.65448,
	-111.90805 41.65083,
	-111.90975 41.64924)', 4326) AS geom)
	
SELECT
	c.ID AS ID,
	c.DataProviderID AS DataProviderID,
	c.DataQualityLevel AS DataQualityLevel,
	c.DateCreated AS DateCreated,
	c.DateLastStatusUpdate AS DateLastStatusUpdate,
	c.DateLastVerified AS DateLastVerified,
	c.GeneralComments AS GeneralComments,
	c.IsRecentlyVerified AS IsRecentlyVerified,
	c.NumberOfPoints AS NumberOfPoints,
	c.OperatorID AS OperatorID,
	c.StatusTypeID AS StatusTypeID,
	c.SubmissionStatusTypeID AS SubmissionStatusTypeID,
	c.UUID AS UUID,
	c.UsageCost AS UsageCost,
	c.UsageTypeID AS UsageTypeID,
	ai.ID AS AddressInfoID, 
	ai.AccessComments AS AccessComments,
	ai.AddressLine1 AS AddressLine1,
	ai.AddressLine2 AS AddressLine2,
	ai.ContactEmail AS ContactEmail,
	ai.ContactTelephone1 AS ContactTelephone1,
	ai.ContactTelephone2 AS ContactTelephone2,
	ai.CountryID AS CountryID,
	ai.DistanceUnit AS DistanceUnit,
	ai.Latitude AS Latitude,
	ai.Longitude AS Longitude,
	ai.Postcode AS Postcode,
	ai.RelatedURL AS RelatedURL,
	ai.StateOrProvince AS StateOrProvince,
	ai.Title AS Title,
	ai.Town AS Town,
	ST_Y(ST_ClosestPoint((SELECT geom FROM line), ST_MakePoint(ai.longitude, ai.latitude)::geography::geometry)) AS intersectionlatitude,
	ST_X(ST_ClosestPoint((SELECT geom FROM line), ST_MakePoint(ai.longitude, ai.latitude)::geography::geometry)) AS intersectionlongitude,
	ST_Distance(ST_MakePoint(ai.longitude, ai.latitude)::geography, (SELECT geom FROM line)) AS DistanceFromRoute
FROM
	ev.charger c
	JOIN ev.addressinfo ai on c.addressinfoid = ai.id
WHERE 
	ST_DWithin(ST_MakePoint(ai.longitude, ai.latitude)::geography, (SELECT geom FROM line), 8046.72);